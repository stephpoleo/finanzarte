<ion-content>
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <div class="app-container">
    <!-- Header -->
    <header class="app-header">
      <div class="header-brand">
        <div class="brand-icon">
          <ion-icon name="wallet-outline"></ion-icon>
        </div>
        <div class="brand-text">
          <h1 class="brand-name">Finanzarte</h1>
          <p class="brand-tagline">El arte de las finanzas</p>
        </div>
      </div>
      <button class="logout-btn" (click)="logout()" title="Cerrar sesi√≥n">
        <ion-icon name="log-out-outline"></ion-icon>
      </button>
    </header>

    <!-- Navigation Tabs -->
    <nav class="nav-tabs-wrapper">
      <div class="nav-tabs">
        <button class="nav-tab" [class.active-green]="activeTab === 'presupuesto'" (click)="activeTab = 'presupuesto'">
          <ion-icon name="home-outline"></ion-icon>
          <span>Presupuesto</span>
        </button>
        <button class="nav-tab" [class.active-cyan]="activeTab === 'emergencia'" (click)="activeTab = 'emergencia'">
          <ion-icon name="shield-outline"></ion-icon>
          <span>Emergencia</span>
        </button>
        <button class="nav-tab" [class.active-amber]="activeTab === 'largo-plazo'" (click)="activeTab = 'largo-plazo'">
          <ion-icon name="leaf-outline"></ion-icon>
          <span>Largo Plazo</span>
        </button>
        <button class="nav-tab" [class.active-purple]="activeTab === 'retiro'" (click)="activeTab = 'retiro'">
          <ion-icon name="flag-outline"></ion-icon>
          <span>Retiro</span>
        </button>
        <button class="nav-tab" [class.active-indigo]="activeTab === 'inversiones'" (click)="activeTab = 'inversiones'">
          <ion-icon name="trending-up-outline"></ion-icon>
          <span>Inversiones</span>
        </button>
      </div>
    </nav>

    <!-- Budget Tab -->
    @if (activeTab === 'presupuesto') {
      <main class="main-content">
        <!-- Income Card -->
        <div class="income-card">
          <div class="income-header">
            <div class="income-title-row">
              <div class="income-icon-box"><ion-icon name="cash-outline"></ion-icon></div>
              <span class="income-title">Ingresos Mensuales</span>
            </div>
            <div class="income-btns">
              <button class="icon-btn" (click)="openCalculatorModal()"><ion-icon name="calculator-outline"></ion-icon></button>
              <button class="icon-btn" (click)="toggleAddIncomeForm()"><ion-icon name="add-outline"></ion-icon></button>
            </div>
          </div>
          <div class="income-amount">{{ incomeSources.totalIncome() | currencyMxn }}</div>

          @if (isAddingIncome) {
            <div class="income-form">
              <div class="form-field">
                <label>Fuente de Ingreso</label>
                <input type="text" placeholder="Ej: Salario, Freelance" [(ngModel)]="newIncome.name" />
              </div>
              <div class="form-field">
                <label>Monto Neto</label>
                <input type="number" placeholder="0.00" [(ngModel)]="newIncome.amount" />
              </div>
              <div class="form-btns">
                <button class="btn-primary-light" (click)="addIncome()">Agregar</button>
                <button class="btn-secondary-light" (click)="cancelAddIncome()">Cancelar</button>
              </div>
            </div>
          }

          @if (incomeSources.incomeSources().length > 0 && !isAddingIncome) {
            <div class="income-list">
              @for (source of incomeSources.incomeSources(); track source.id) {
                @if (editingIncomeId === source.id) {
                  <div class="income-edit-form">
                    <div class="form-row">
                      <input type="text" [(ngModel)]="editIncome.name" placeholder="Nombre" />
                      <input type="number" [(ngModel)]="editIncome.amount" placeholder="Monto" />
                    </div>
                    <div class="form-btns-inline">
                      <button class="btn-save" (click)="saveIncomeEdit()"><ion-icon name="checkmark-outline"></ion-icon></button>
                      <button class="btn-cancel" (click)="cancelIncomeEdit()"><ion-icon name="close-outline"></ion-icon></button>
                    </div>
                  </div>
                } @else {
                  <div class="income-item">
                    <ion-icon name="briefcase-outline"></ion-icon>
                    <span class="income-item-name">{{ source.name }}</span>
                    <span class="income-item-badge">{{ source.amount | currencyMxn }}</span>
                    <button class="income-item-edit" (click)="startEditIncome(source)">
                      <ion-icon name="create-outline"></ion-icon>
                    </button>
                    <button class="income-item-delete" (click)="deleteIncomeSource(source.id)">
                      <ion-icon name="trash-outline"></ion-icon>
                    </button>
                  </div>
                }
              }
            </div>
          }

          @if (incomeSources.incomeSources().length === 0 && !isAddingIncome) {
            <p class="income-empty">Agrega tus fuentes de ingreso</p>
          }
        </div>

        <!-- Expenses -->
        <div class="expense-card">
          <div class="expense-header">
            <div class="expense-header-left">
              <div class="expense-icon-box"><ion-icon name="trending-down-outline"></ion-icon></div>
              <span class="expense-title">Gastos Mensuales</span>
            </div>
            <button class="icon-btn" (click)="toggleAddExpenseForm()"><ion-icon name="add-outline"></ion-icon></button>
          </div>
          <div class="expense-amount">{{ expenses.totalExpenses() | currencyMxn }}</div>

          @if (isAddingExpense) {
            <div class="expense-form">
              <div class="form-field">
                <label>Nombre del Gasto</label>
                <input type="text" placeholder="Ej: Renta, Netflix" [(ngModel)]="newExpense.name" />
              </div>
              <div class="form-field">
                <label>Monto</label>
                <input type="number" placeholder="0.00" [(ngModel)]="newExpense.amount" />
              </div>
              <div class="form-grid-2">
                <div class="form-field">
                  <label>Tipo</label>
                  <select [(ngModel)]="newExpense.type">
                    <option value="fixed">Fijo</option>
                    <option value="variable">Variable</option>
                  </select>
                </div>
                <div class="form-field">
                  <label>Categor√≠a</label>
                  <select [(ngModel)]="newExpense.category">
                    @for (cat of expenseCategories; track cat.value) {
                      <option [value]="cat.value">{{ cat.label }}</option>
                    }
                  </select>
                </div>
              </div>
              <div class="form-btns">
                <button class="btn-primary-dark" (click)="addExpense()">Agregar</button>
                <button class="btn-secondary-dark" (click)="cancelAddExpense()">Cancelar</button>
              </div>
            </div>
          }

          @if (!isAddingExpense) {
            @if (getFixedExpenses().length > 0) {
              <div class="expense-section" [class.expanded]="fixedExpensesExpanded">
                <div class="expense-section-hdr" (click)="toggleFixedExpenses()">
                  <div class="expense-section-left">
                    <ion-icon name="chevron-down-outline" class="chevron"></ion-icon>
                    <span>Gastos Fijos</span>
                    <span class="expense-count">({{ getFixedExpenses().length }})</span>
                  </div>
                  <span class="expense-section-total">{{ expenses.totalFixedExpenses() | currencyMxn }}</span>
                </div>
                @if (fixedExpensesExpanded) {
                  <div class="expense-items">
                    @for (exp of getFixedExpenses(); track exp.id) {
                      @if (editingExpenseId === exp.id) {
                        <div class="expense-edit-form">
                          <div class="form-row">
                            <input type="text" [(ngModel)]="editExpense.name" placeholder="Nombre" />
                            <input type="number" [(ngModel)]="editExpense.amount" placeholder="Monto" />
                          </div>
                          <div class="form-row">
                            <select [(ngModel)]="editExpense.type">
                              <option value="fixed">Fijo</option>
                              <option value="variable">Variable</option>
                            </select>
                            <select [(ngModel)]="editExpense.category">
                              @for (cat of expenseCategories; track cat.value) {
                                <option [value]="cat.value">{{ cat.label }}</option>
                              }
                            </select>
                          </div>
                          <div class="form-btns-inline">
                            <button class="btn-save" (click)="saveExpenseEdit()"><ion-icon name="checkmark-outline"></ion-icon></button>
                            <button class="btn-cancel" (click)="cancelExpenseEdit()"><ion-icon name="close-outline"></ion-icon></button>
                          </div>
                        </div>
                      } @else {
                        <div class="expense-row">
                          <div class="expense-icon" [style.background]="getCategoryColor(exp.category)"><ion-icon [name]="getCategoryIcon(exp.category)"></ion-icon></div>
                          <div class="expense-info"><span class="expense-name">{{ exp.name }}</span><span class="expense-cat">{{ getCategoryLabel(exp.category) }}</span></div>
                          <div class="expense-values">
                            <span class="expense-amt">{{ exp.amount | currencyMxn }}</span>
                            <span class="expense-pct">{{ getExpensePercentage(exp.amount) | number:'1.1-1' }}%</span>
                          </div>
                          <button class="expense-edit" (click)="startEditExpense(exp)"><ion-icon name="create-outline"></ion-icon></button>
                          <button class="expense-del" (click)="deleteExpense(exp.id)"><ion-icon name="trash-outline"></ion-icon></button>
                        </div>
                      }
                    }
                  </div>
                }
              </div>
            }

            @if (getVariableExpenses().length > 0) {
              <div class="expense-section" [class.expanded]="variableExpensesExpanded">
                <div class="expense-section-hdr" (click)="toggleVariableExpenses()">
                  <div class="expense-section-left">
                    <ion-icon name="chevron-down-outline" class="chevron"></ion-icon>
                    <span>Gastos Variables</span>
                    <span class="expense-count">({{ getVariableExpenses().length }})</span>
                  </div>
                  <span class="expense-section-total">{{ expenses.totalVariableExpenses() | currencyMxn }}</span>
                </div>
                @if (variableExpensesExpanded) {
                  <div class="expense-items">
                    @for (exp of getVariableExpenses(); track exp.id) {
                      @if (editingExpenseId === exp.id) {
                        <div class="expense-edit-form">
                          <div class="form-row">
                            <input type="text" [(ngModel)]="editExpense.name" placeholder="Nombre" />
                            <input type="number" [(ngModel)]="editExpense.amount" placeholder="Monto" />
                          </div>
                          <div class="form-row">
                            <select [(ngModel)]="editExpense.type">
                              <option value="fixed">Fijo</option>
                              <option value="variable">Variable</option>
                            </select>
                            <select [(ngModel)]="editExpense.category">
                              @for (cat of expenseCategories; track cat.value) {
                                <option [value]="cat.value">{{ cat.label }}</option>
                              }
                            </select>
                          </div>
                          <div class="form-btns-inline">
                            <button class="btn-save" (click)="saveExpenseEdit()"><ion-icon name="checkmark-outline"></ion-icon></button>
                            <button class="btn-cancel" (click)="cancelExpenseEdit()"><ion-icon name="close-outline"></ion-icon></button>
                          </div>
                        </div>
                      } @else {
                        <div class="expense-row">
                          <div class="expense-icon" [style.background]="getCategoryColor(exp.category)"><ion-icon [name]="getCategoryIcon(exp.category)"></ion-icon></div>
                          <div class="expense-info"><span class="expense-name">{{ exp.name }}</span><span class="expense-cat">{{ getCategoryLabel(exp.category) }}</span></div>
                          <div class="expense-values">
                            <span class="expense-amt">{{ exp.amount | currencyMxn }}</span>
                            <span class="expense-pct">{{ getExpensePercentage(exp.amount) | number:'1.1-1' }}%</span>
                          </div>
                          <button class="expense-edit" (click)="startEditExpense(exp)"><ion-icon name="create-outline"></ion-icon></button>
                          <button class="expense-del" (click)="deleteExpense(exp.id)"><ion-icon name="trash-outline"></ion-icon></button>
                        </div>
                      }
                    }
                  </div>
                }
              </div>
            }

            @if (expenses.expenses().length === 0) {
              <p class="expense-empty">Agrega tus gastos mensuales</p>
            }
          }
        </div>

        <!-- Charts Carousel -->
        <div class="card">
          <div class="charts-header">
            <div>
              <h3 class="card-title">{{ chartTitles[currentChart] }}</h3>
              <p class="card-subtitle">{{ chartSubtitles[currentChart] }}</p>
            </div>
            <div class="charts-nav">
              <button class="nav-arrow" (click)="prevChart()"><ion-icon name="chevron-back-outline"></ion-icon></button>
              <div class="dots">
                @for (i of [0, 1, 2]; track i) {
                  <span class="dot" [class.active]="currentChart === i"></span>
                }
              </div>
              <button class="nav-arrow" (click)="nextChart()"><ion-icon name="chevron-forward-outline"></ion-icon></button>
            </div>
          </div>

          @if (hasChartData()) {
            <div class="chart-wrapper">
              <svg class="pie-chart" viewBox="0 0 200 200">
                <circle cx="100" cy="100" r="70" fill="none" stroke="#f3f4f6" stroke-width="24"/>
                @for (seg of getChartSegments(); track $index) {
                  <circle cx="100" cy="100" r="70" fill="none" [attr.stroke]="seg.color" stroke-width="24"
                    [attr.stroke-dasharray]="seg.dashArray" [attr.stroke-dashoffset]="seg.offset" transform="rotate(-90 100 100)"/>
                }
                <!-- White separator lines between segments -->
                @for (sep of getChartSeparators(); track $index) {
                  <line [attr.x1]="sep.x1" [attr.y1]="sep.y1" [attr.x2]="sep.x2" [attr.y2]="sep.y2"
                        stroke="white" stroke-width="4"/>
                }
              </svg>
              @if (currentChart === 2) {
                <div class="chart-center">
                  <span class="chart-pct">{{ savingsRate() }}%</span>
                  <span class="chart-lbl">Ahorro</span>
                </div>
              }
            </div>
            <div class="chart-legend">
              @for (item of getChartLegend(); track item.label) {
                <div class="legend-row">
                  <span class="legend-dot" [style.background]="item.color"></span>
                  <span class="legend-name">{{ item.label }}</span>
                  <span class="legend-pct">{{ getChartPercentage(item.value) | number:'1.1-1' }}%</span>
                  <span class="legend-val">{{ item.value | currencyMxn }}</span>
                </div>
              }
            </div>
            @if (currentChart === 2 && incomeSources.totalIncome() > 0) {
              <div class="rate-box">
                <span class="rate-title">Tasa de Ahorro</span>
                <div class="rate-row">
                  <span class="rate-pct" [class.good]="savingsRate() >= 20" [class.warn]="savingsRate() >= 10 && savingsRate() < 20" [class.bad]="savingsRate() < 10">{{ savingsRate() }}%</span>
                  <span class="rate-msg">@if (savingsRate() >= 20) {¬°Excelente!} @else if (savingsRate() >= 10) {Buen ritmo} @else {Puedes mejorar}</span>
                </div>
              </div>
            }
          } @else {
            <div class="chart-empty">
              @if (currentChart === 0) {Agrega fuentes de ingreso para ver la distribuci√≥n}
              @else if (currentChart === 1) {Agrega gastos para ver la distribuci√≥n}
              @else {Completa tu presupuesto para ver el resumen}
            </div>
          }
        </div>

        <!-- Savings Allocation -->
        <div class="card savings-allocation-card">
          <div class="card-header-row">
            <div class="card-header-left">
              <ion-icon name="pie-chart-outline" class="icon-green"></ion-icon>
              <h3 class="card-title">Distribuci√≥n de tu Ahorro</h3>
            </div>
          </div>

          <!-- Total Available -->
          <div class="alloc-total">
            <div class="alloc-total-left">
              <span class="alloc-total-label">Ahorro mensual disponible</span>
              <span class="alloc-total-pct">{{ savingsRate() }}% de tus ingresos</span>
            </div>
            <span class="alloc-total-value">{{ emergencyAvailableSavings | currencyMxn }}</span>
          </div>

          <!-- Emergency Fund Allocation -->
          <div class="alloc-section-box emergency" (click)="activeTab = 'emergencia'">
            <div class="alloc-section-header">
              <div class="alloc-section-left">
                <span class="alloc-section-icon">üö®</span>
                <div class="alloc-section-info">
                  <span class="alloc-section-title">Fondo de Emergencia</span>
                  <span class="alloc-section-subtitle">{{ emergencyMonthsCovered | number:'1.1-1' }} de {{ currentMilestoneTarget }} meses</span>
                </div>
              </div>
              <div class="alloc-section-right">
                <span class="alloc-section-amount">-{{ emergencyContributionAmount | currencyMxn }}</span>
                <span class="alloc-section-pct">({{ emergencyRecommendedPercentage }}%)</span>
              </div>
            </div>
            <div class="alloc-section-bar">
              <div class="alloc-section-fill" [style.width.%]="emergencyProgressBarWidth"></div>
            </div>
            <span class="alloc-section-link">Ver detalle en Emergencia ‚Üí</span>
          </div>

          <!-- Free for Personal Goals -->
          <div class="alloc-free">
            <div class="alloc-free-header">
              <span class="alloc-free-icon">‚ú®</span>
              <span class="alloc-free-label">Libre para metas personales</span>
            </div>
            <span class="alloc-free-value">{{ freeForPersonalGoals | currencyMxn }}</span>
          </div>

          <!-- Personal Goals Section -->
          @if (savingsGoalsLocked && !savingsGoalsUnlocked) {
            <div class="goals-locked-mini">
              <ion-icon name="lock-closed-outline"></ion-icon>
              <span>Desbloquea metas personales alcanzando 1 mes de fondo de emergencia</span>
              <button class="unlock-btn-mini" (click)="unlockSavingsGoals()">Desbloquear</button>
            </div>
          } @else {
            <div class="personal-goals-section">
              <div class="personal-goals-header">
                <span class="personal-goals-title">Tus metas</span>
                <button class="add-btn-small" (click)="openGoalModal()"><ion-icon name="add-outline"></ion-icon></button>
              </div>

              @if (personalGoals.length > 0) {
                <div class="personal-goals-list">
                  @for (goal of personalGoals; track goal.id) {
                    <div class="personal-goal-card">
                      <div class="personal-goal-main">
                        <app-progress-ring [progress]="getGoalProgress(goal)" [size]="44" [strokeWidth]="4" [color]="goal.color || '#8b5cf6'"></app-progress-ring>
                        <div class="personal-goal-info">
                          <span class="personal-goal-name">{{ goal.name }}</span>
                          <span class="personal-goal-amounts">
                            <span class="current">{{ goal.current_amount | currencyMxn }}</span> / {{ goal.target_amount | currencyMxn }}
                          </span>
                        </div>
                        <span class="personal-goal-pct">{{ getGoalProgress(goal) | number:'1.0-0' }}%</span>
                      </div>
                      <div class="personal-goal-details">
                        <div class="personal-goal-suggestion">
                          <ion-icon name="cash-outline"></ion-icon>
                          <span>Aporte sugerido: <strong>{{ getSuggestedMonthlyForGoal(goal) | currencyMxn }}/mes</strong></span>
                        </div>
                        <div class="personal-goal-date">
                          <ion-icon name="calendar-outline"></ion-icon>
                          <span>Completar: <strong>{{ formatCompletionDate(goal) }}</strong></span>
                        </div>
                      </div>
                      <div class="personal-goal-actions">
                        <button class="goal-action-btn" (click)="openEditGoalModal(goal, $event)"><ion-icon name="create-outline"></ion-icon></button>
                        <button class="goal-action-btn danger" (click)="deleteGoal(goal.id, $event)"><ion-icon name="trash-outline"></ion-icon></button>
                      </div>
                    </div>
                  }
                </div>
              } @else {
                <div class="no-goals-hint">
                  <p>No tienes metas personales a√∫n</p>
                  <span>Ejemplos: Vacaciones, Carro, Gadget, Enganche de casa</span>
                </div>
              }

              <!-- Unassigned Savings Hint -->
              @if (freeForPersonalGoals > 0 && personalGoals.length === 0) {
                <div class="unassigned-hint" (click)="activeTab = 'largo-plazo'">
                  <ion-icon name="leaf-outline"></ion-icon>
                  <div class="unassigned-hint-text">
                    <span class="hint-title">Sin metas? Considera Largo Plazo</span>
                    <span class="hint-desc">Invierte {{ freeForPersonalGoals | currencyMxn }}/mes para tu libertad financiera</span>
                  </div>
                  <ion-icon name="chevron-forward-outline" class="hint-arrow"></ion-icon>
                </div>
              }
            </div>
          }
        </div>
      </main>
    }

    <!-- Emergency Tab -->
    @if (activeTab === 'emergencia') {
      <main class="main-content">
        <div class="emergency-card">
          <div class="emergency-header"><div class="emergency-icon"><ion-icon name="shield-outline"></ion-icon></div><div><h3>Fondo de Emergencia</h3><p>Tu red de seguridad financiera</p></div></div>
          <div class="emergency-stats">
            <span class="stat-label">Ahorros Actuales</span>
            <div class="stat-input-row">
              <span class="currency-prefix">$</span>
              <input type="number" class="stat-input" [(ngModel)]="emergencyCurrentSavings" placeholder="0"/>
            </div>
            <span class="stat-hint"><ion-icon name="checkmark-circle-outline"></ion-icon> Cubres {{ emergencyMonthsCovered | number:'1.1-1' }} meses de {{ emergencyCalcBase === 'income' ? 'ingresos' : 'gastos' }}</span>
          </div>
          <div class="emergency-rec"><span class="rec-label">Recomendaci√≥n</span><span class="rec-pct">Destina {{ emergencyRecommendedPercentage }}% de tu ahorro</span><span class="rec-amount">{{ emergencyRecommendedAmount | currencyMxn }}</span></div>
        </div>
        <div class="card"><h3 class="card-title">Ruta de Ahorro</h3><p class="card-subtitle">Progresa dedicando el % recomendado</p>
          <div class="calc-toggle">
            <span class="toggle-label">Calcular en base a:</span>
            <div class="toggle-buttons">
              <button class="toggle-btn" [class.active]="emergencyCalcBase === 'expenses'" (click)="emergencyCalcBase = 'expenses'">Gastos</button>
              <button class="toggle-btn" [class.active]="emergencyCalcBase === 'income'" (click)="emergencyCalcBase = 'income'">Ingresos</button>
            </div>
          </div>
          <div class="milestones">
            @for (m of emergencyMilestones; track m.months) {
              <div class="milestone" [class.done]="isMilestoneDone(m.months)" [class.current]="isCurrentMilestone(m.months)">
                <div class="milestone-hdr">
                  <div class="milestone-left">
                    @if (isMilestoneDone(m.months)) {<ion-icon name="checkmark-circle" class="check"></ion-icon>} @else {<ion-icon name="ellipse-outline" class="circle"></ion-icon>}
                    <div><span class="milestone-label" [style.color]="m.color">{{ m.label }}</span><span class="milestone-target">Meta: {{ getMilestoneTarget(m) | currencyMxn }}</span></div>
                  </div>
                  <span class="milestone-badge">{{ m.recommendedPercentage }}%</span>
                </div>
                @if (!isMilestoneDone(m.months)) {<div class="progress-bar"><div class="progress-fill" [style.width.%]="getMilestoneProgress(m.months)"></div></div>}
              </div>
            }
          </div>
        </div>
        <div class="card tips collapsible" [class.expanded]="emergencyTipsExpanded">
          <div class="tips-header" (click)="toggleEmergencyTips()">
            <h3>üí° ¬øPor qu√© este sistema?</h3>
            <ion-icon name="chevron-down-outline" class="chevron"></ion-icon>
          </div>
          @if (emergencyTipsExpanded) {
            <ul><li><strong>Base ($10k):</strong> M√≠nimo absoluto para cualquier emergencia.</li><li><strong>1-3 meses:</strong> Prioridad m√°xima (100%).</li><li><strong>3-6 meses:</strong> Reduce a 75%.</li><li><strong>6-12 meses:</strong> 50% es suficiente.</li><li><strong>12+ meses:</strong> 25% para mantener.</li></ul>
          }
        </div>

        <!-- Where to put your emergency fund -->
        <div class="card allocation-card">
          <div class="card-header-row">
            <ion-icon name="wallet-outline" class="icon-cyan"></ion-icon>
            <h3 class="card-title">¬øD√≥nde guardar tu fondo?</h3>
          </div>

          <!-- SOFIPOs Row -->
          <div class="alloc-row">
            <div class="alloc-left">
              <span class="alloc-icon">üè¶</span>
              <div class="alloc-info">
                <span class="alloc-label">SOFIPOs</span>
                <span class="alloc-value">{{ emergencyAllocation.sofipoAmount | currencyMxn }}</span>
              </div>
            </div>
            <div class="alloc-right">
              <div class="alloc-progress">
                <div class="alloc-bar"><div class="alloc-fill sofipo" [style.width.%]="(emergencyAllocation.sofipoAmount / taxExemptLimit) * 100"></div></div>
                <span class="alloc-pct">{{ (emergencyAllocation.sofipoAmount / taxExemptLimit * 100) | number:'1.0-0' }}%</span>
              </div>
              <span class="alloc-limit">de {{ taxExemptLimit | currencyMxn }} exento</span>
            </div>
          </div>

          @if (emergencyAllocation.cetesAmount > 0) {
            <!-- CETES Row -->
            <div class="alloc-row cetes">
              <div class="alloc-left">
                <span class="alloc-icon">üá≤üáΩ</span>
                <div class="alloc-info">
                  <span class="alloc-label">CETES</span>
                  <span class="alloc-value">{{ emergencyAllocation.cetesAmount | currencyMxn }}</span>
                </div>
              </div>
              <div class="alloc-right">
                <span class="alloc-note">Excedente</span>
              </div>
            </div>
          }

          <p class="alloc-hint">{{ emergencyAllocation.recommendation }}</p>
        </div>

        <!-- SOFIPOs Carousel -->
        <div class="card sofipos-card">
          <h3 class="card-title">SOFIPOs Populares</h3>
          <p class="card-subtitle">Desliza para ver m√°s opciones</p>

          <div class="sofipos-carousel">
            @for (sofipo of sofipos; track sofipo.id; let i = $index) {
              <div class="sofipo-card" [class.best]="i === 0">
                @if (i === 0) {
                  <span class="best-badge">üèÜ Mejor tasa</span>
                }
                <span class="sofipo-name">{{ sofipo.name }}</span>
                <div class="sofipo-rate">
                  <span class="rate-number">{{ sofipo.annualRate }}%</span>
                  <span class="rate-period">anual</span>
                </div>
                <span class="sofipo-term">{{ sofipo.term }}</span>
              </div>
            }
          </div>

          <div class="instrument-footer">
            <span class="ipab-badge"><ion-icon name="shield-checkmark-outline"></ion-icon> Protegidos por IPAB hasta ~$2.9M</span>
          </div>
        </div>

        <!-- CETES Info -->
        <div class="card">
          <h3 class="card-title">CETES</h3>
          <p class="card-subtitle">Certificados de la Tesorer√≠a - m√°xima seguridad</p>

          <div class="cetes-info">
            <div class="cetes-rate">
              <span class="rate-value">~{{ cetesInfo.annualRate }}%</span>
              <span class="rate-label">anual (variable)</span>
            </div>
            <div class="cetes-details">
              <div class="detail-item"><ion-icon name="cash-outline"></ion-icon><span>M√≠nimo: {{ cetesInfo.minAmount | currencyMxn }}</span></div>
              <div class="detail-item"><ion-icon name="calendar-outline"></ion-icon><span>Plazos: {{ cetesInfo.term }}</span></div>
              <div class="detail-item"><ion-icon name="shield-outline"></ion-icon><span>Respaldados por el gobierno federal</span></div>
            </div>
          </div>

          <div class="cetes-footer">
            <a href="https://cetesdirecto.com" target="_blank" class="cetes-link">
              <span>Abrir cuenta en CetesDirecto</span>
              <ion-icon name="open-outline"></ion-icon>
            </a>
          </div>
        </div>

        <!-- Strategy Tips -->
        <div class="card tips collapsible" [class.expanded]="strategyTipsExpanded">
          <div class="tips-header" (click)="toggleStrategyTips()">
            <h3>üí° Estrategia recomendada</h3>
            <ion-icon name="chevron-down-outline" class="chevron"></ion-icon>
          </div>
          @if (strategyTipsExpanded) {
            <ul>
              <li><strong>Primero SOFIPOs:</strong> Hasta {{ taxExemptLimit | currencyMxn }} (5 UMAs) tus intereses est√°n exentos de ISR.</li>
              <li><strong>Despu√©s CETES:</strong> El excedente ponlo en CETES. Aunque retienen ISR, tienen la m√°xima seguridad.</li>
              <li><strong>Diversifica SOFIPOs:</strong> El IPAB protege hasta ~$2.9M por instituci√≥n. Si tienes m√°s, divide entre varias.</li>
              <li><strong>Liquidez:</strong> Prefiere opciones sin plazo fijo para emergencias reales.</li>
            </ul>
          }
        </div>
      </main>
    }

    <!-- Long Term Tab -->
    @if (activeTab === 'largo-plazo') {
      <main class="main-content">
        <div class="hero-card amber">
          <div class="hero-header"><div class="hero-icon"><ion-icon name="leaf-outline"></ion-icon></div><div><h3>Ahorro a Largo Plazo</h3><p>Tu camino a la libertad financiera</p></div></div>
          <div class="hero-stat">
            <span class="stat-label">Ahorros Invertidos Actuales</span>
            <span class="stat-value">{{ ltCurrentSavings | currencyMxn }}</span>
            <span class="stat-hint">@if (ltCurrentLevel) {<ion-icon name="checkmark-circle-outline"></ion-icon> Nivel: {{ ltCurrentLevel.name }}} @else {Comienza tu camino a la libertad}</span>
          </div>
          <div class="hero-grid">
            <div class="hero-box"><span class="box-label">Ingreso Pasivo Mensual</span><span class="box-value">{{ ltMonthlyPassiveIncome | currencyMxn }}</span><span class="box-hint">Regla del 4% anual</span></div>
            <div class="hero-box"><span class="box-label">Cobertura de Gastos</span><span class="box-value">{{ ltCoveragePercentage | number:'1.0-0' }}%</span><span class="box-hint">@if (ltCoveragePercentage >= 100) {¬°Libertad alcanzada!} @else {de tus gastos}</span></div>
          </div>
        </div>

        <div class="alert-warning"><ion-icon name="warning-outline"></ion-icon><p><strong>¬°Importante!</strong> Este dinero DEBE estar invertido. Sin rendimientos, la inflaci√≥n destruye tu poder adquisitivo (~4-6% anual). Considera ETFs indexados, CETES, fondos de inversi√≥n o bonos.</p></div>

        <div class="card"><h3 class="card-title">Configuraci√≥n</h3>
          <div class="form-field"><label>Gastos Mensuales Totales</label><input type="number" [(ngModel)]="ltMonthlyExpenses" placeholder="0.00"/><span class="hint">Todos tus gastos mensuales</span></div>
          <div class="form-field"><label>Ahorros Actuales para Largo Plazo</label><input type="number" [(ngModel)]="ltCurrentSavings" placeholder="0.00"/><span class="hint">Solo cuenta dinero invertido</span></div>
          <div class="form-field"><label>Ahorro Mensual</label><input type="number" [(ngModel)]="ltMonthlySavings" placeholder="0.00"/><span class="hint">¬øCu√°nto puedes invertir cada mes?</span></div>
          <div class="form-field"><label>Retorno Anual Esperado (%)</label><input type="number" [(ngModel)]="ltAnnualReturn" placeholder="8"/><span class="hint">Conservador: 5-7% | Moderado: 8-10% | Agresivo: 12%+</span></div>
        </div>

        <div class="card"><h3 class="card-title">Niveles de Libertad Financiera</h3><p class="card-subtitle">Cada nivel representa un hito en tu independencia econ√≥mica</p>
          <div class="levels-list">
            @for (level of financialLevels; track level.name) {
              <div class="level-card" [class.completed]="isLevelCompleted(level)" [class.current]="ltNextLevel?.name === level.name">
                <div class="level-header">
                  <div class="level-left">
                    <div class="level-icon" [class]="level.bgClass"><ion-icon [name]="level.icon"></ion-icon></div>
                    <div><span class="level-name" [class]="level.color">{{ level.name }}</span><span class="level-desc">{{ level.description }}</span><span class="level-meaning">{{ level.meaning }}</span></div>
                  </div>
                  @if (isLevelCompleted(level)) {<ion-icon name="checkmark-circle" class="level-check"></ion-icon>}
                </div>
                <div class="level-target"><span>Meta de ahorro</span><span class="level-amount">{{ getLevelTarget(level) | currencyMxn }}</span></div>
                <div class="progress-bar"><div class="progress-fill" [style.width.%]="getLevelProgress(level)"></div></div>
                @if (!isLevelCompleted(level) && isYearsValid(getYearsToLevel(level))) {
                  <div class="level-time"><ion-icon name="time-outline"></ion-icon> <strong>{{ getYearsToLevel(level) | number:'1.1-1' }} a√±os</strong> para alcanzar</div>
                }
                @if (isLevelCompleted(level)) {<div class="level-done">‚úì ¬°Nivel alcanzado!</div>}
              </div>
            }
          </div>
        </div>

        @if (ltNextLevel) {
          <div class="card next-level">
            <h3 class="card-title">Siguiente Nivel: {{ ltNextLevel.name }}</h3>
            <div class="next-info"><span>Meta</span><span class="next-amount">{{ getLevelTarget(ltNextLevel) | currencyMxn }}</span></div>
            <div class="next-info"><span>Falta por ahorrar</span><span class="next-amount">{{ getLevelTarget(ltNextLevel) - ltCurrentSavings | currencyMxn }}</span></div>
            @if (isYearsValid(getYearsToLevel(ltNextLevel))) {
              <div class="next-time"><span class="time-label">Tiempo estimado</span><span class="time-value">{{ getYearsToLevel(ltNextLevel) | number:'1.1-1' }} a√±os</span><span class="time-hint">Ahorrando {{ ltMonthlySavings | currencyMxn }}/mes con {{ ltAnnualReturn }}% retorno</span></div>
            }
          </div>
        }

        <div class="card compound-card">
          <h3 class="card-title"><ion-icon name="trending-up-outline"></ion-icon> El Poder del Inter√©s Compuesto</h3>
          <div class="projection-grid">
            <div class="projection-item"><span class="proj-label">5 a√±os</span><span class="proj-value">{{ getProjectedSavings(5) | currencyMxn }}</span></div>
            <div class="projection-item"><span class="proj-label">10 a√±os</span><span class="proj-value">{{ getProjectedSavings(10) | currencyMxn }}</span></div>
            <div class="projection-item"><span class="proj-label">20 a√±os</span><span class="proj-value">{{ getProjectedSavings(20) | currencyMxn }}</span></div>
          </div>
          <p class="proj-note">* Proyecciones asumiendo {{ ltAnnualReturn }}% de retorno anual</p>
        </div>

        <div class="card tips">
          <h3>üí° La Regla del 4%</h3>
          <p>Si retiras el 4% anualmente de tu capital invertido, este deber√≠a durar indefinidamente. Es decir: $1,000,000 te da $40,000/a√±o ($3,333/mes) de forma perpetua.</p>
          <div class="formula">Gastos mensuales √ó 12 √ó 25 = Capital necesario</div>
          <div class="result">Con gastos de {{ ltMonthlyExpenses | currencyMxn }}/mes, necesitas <strong>{{ ltAnnualExpenses * 25 | currencyMxn }}</strong> invertidos</div>
        </div>
      </main>
    }

    <!-- Retirement Tab -->
    @if (activeTab === 'retiro') {
      <main class="main-content">
        <div class="hero-card purple">
          <div class="hero-header"><div class="hero-icon"><ion-icon name="flag-outline"></ion-icon></div><div><h3>Plan de Retiro</h3><p>Planifica tu futuro financiero</p></div></div>
          <div class="hero-stat">
            <span class="stat-label">Proyecci√≥n al Retiro</span>
            <span class="stat-value">{{ retTotalFund | currencyMxn }}</span>
            <span class="stat-hint">En {{ retYearsToRetirement }} a√±os ({{ retRetirementAge }} a√±os)</span>
          </div>
          <div class="hero-grid">
            <div class="hero-box"><ion-icon name="calendar-outline"></ion-icon><span class="box-label">A√±os hasta retiro</span><span class="box-value">{{ retYearsToRetirement }}</span></div>
            <div class="hero-box"><ion-icon name="trending-up-outline"></ion-icon><span class="box-label">Retorno anual</span><span class="box-value">{{ retExpectedReturn }}%</span></div>
          </div>
        </div>

        <div class="card"><h3 class="card-title">Par√°metros de Planificaci√≥n</h3>
          <div class="form-grid-2">
            <div class="form-field"><label>Edad Actual</label><input type="number" [(ngModel)]="retCurrentAge" placeholder="30"/></div>
            <div class="form-field"><label>Edad de Retiro</label><input type="number" [(ngModel)]="retRetirementAge" placeholder="65"/></div>
          </div>
          <div class="form-field"><label>Ahorros Actuales para Retiro</label><input type="number" [(ngModel)]="retCurrentSavings" placeholder="0.00"/></div>
          <div class="form-field"><label>Contribuci√≥n Mensual</label><input type="number" [(ngModel)]="retMonthlyContribution" placeholder="0.00"/></div>
          <div class="form-field"><label>Retorno Anual Esperado (%)</label><input type="number" [(ngModel)]="retExpectedReturn" placeholder="7"/></div>
        </div>

        <div class="card"><h3 class="card-title">An√°lisis de Suficiencia</h3>
          <div class="analysis-row"><span>Fondo Proyectado</span><span class="analysis-value">{{ retTotalFund | currencyMxn }}</span></div>
          <div class="analysis-row"><span>Fondo Recomendado</span><span class="analysis-value">{{ retRecommendedFund | currencyMxn }}</span></div>
          <div class="progress-bar"><div class="progress-fill" [style.width.%]="retFundProgress"></div></div>
          <p class="analysis-hint">@if (retTotalFund >= retRecommendedFund) {‚úì Tu plan est√° en camino a cumplir las recomendaciones} @else {Considera aumentar tu contribuci√≥n mensual}</p>
          <div class="ret-income-box">
            <span class="income-label">Ingreso Mensual Estimado</span>
            <span class="income-value">{{ retMonthlyIncome | currencyMxn }}</span>
            <span class="income-hint">Usando la regla del 4% de retiro anual</span>
          </div>
        </div>
      </main>
    }

    <!-- Investments Tab -->
    @if (activeTab === 'inversiones') {
      <main class="main-content">
        <div class="hero-card blue">
          <div class="hero-header"><div class="hero-icon"><ion-icon name="trending-up-outline"></ion-icon></div><div><h3>Inversiones</h3><p>Haz crecer tu patrimonio</p></div></div>
          <div class="hero-grid">
            <div class="hero-box large"><ion-icon name="cash-outline"></ion-icon><span class="box-label">Total Invertido</span><span class="box-value big">{{ totalInvested | currencyMxn }}</span></div>
            <div class="hero-box large"><ion-icon name="pie-chart-outline"></ion-icon><span class="box-label">Retorno Promedio</span><span class="box-value big">{{ weightedReturn | number:'1.1-1' }}%</span></div>
          </div>
          <div class="hero-box full"><span class="box-label">Retorno Anual Proyectado</span><span class="box-value">{{ projectedAnnualReturn | currencyMxn }}</span></div>
        </div>

        <div class="card">
          <div class="card-header-row"><h3 class="card-title">Tu Portafolio</h3><button class="add-btn" (click)="toggleInvestmentForm()"><ion-icon name="add-outline"></ion-icon></button></div>

          @if (showInvestmentForm) {
            <div class="investment-form">
              <div class="form-field"><label>Nombre de la Inversi√≥n</label><input type="text" [(ngModel)]="newInvestment.name" placeholder="Ej: S&P 500 ETF"/></div>
              <div class="form-grid-2">
                <div class="form-field"><label>Tipo</label>
                  <select [(ngModel)]="newInvestment.type">@for (t of investmentTypes; track t.value) {<option [value]="t.value">{{ t.label }}</option>}</select>
                </div>
                <div class="form-field"><label>Monto Invertido</label><input type="number" [(ngModel)]="newInvestment.amount" placeholder="0.00"/></div>
              </div>
              <div class="form-field"><label>Retorno Anual Esperado (%)</label><input type="number" [(ngModel)]="newInvestment.expected_return" placeholder="8"/></div>
              <div class="form-btns"><button class="btn-primary" (click)="addInvestment()">Agregar Inversi√≥n</button><button class="btn-secondary" (click)="toggleInvestmentForm()">Cancelar</button></div>
            </div>
          }

          <div class="investments-list">
            @for (inv of investmentSvc.investments(); track inv.id) {
              <div class="investment-row">
                <div class="inv-icon" [style.background]="getInvestmentTypeColor(inv.type)"><ion-icon name="trending-up-outline"></ion-icon></div>
                <div class="inv-info"><span class="inv-name">{{ inv.name }}</span><span class="inv-type">{{ getInvestmentTypeLabel(inv.type) }}</span></div>
                <div class="inv-values"><span class="inv-amount">{{ inv.amount | currencyMxn }}</span><span class="inv-return">{{ inv.expected_return }}% anual</span></div>
                <button class="inv-delete" (click)="deleteInvestment(inv.id)"><ion-icon name="trash-outline"></ion-icon></button>
              </div>
            }
          </div>

          @if (investmentSvc.investments().length === 0 && !showInvestmentForm) {
            <p class="empty-msg">No hay inversiones registradas</p>
          }
        </div>

        <!-- Rule of 120 Card - Always visible -->
        <div class="card rule120-card" [class.balanced]="riskAllocationStatus === 'balanced'" [class.too-risky]="riskAllocationStatus === 'too-risky'" [class.too-conservative]="riskAllocationStatus === 'too-conservative'">
          <div class="rule120-header">
            <div class="rule120-icon"><ion-icon name="scale-outline"></ion-icon></div>
            <div>
              <h3 class="card-title">Regla del 120</h3>
              <p class="card-subtitle">Balance riesgo vs seguridad seg√∫n tu edad</p>
            </div>
          </div>

          <div class="rule120-formula">
            <span class="formula-text">120 - {{ retCurrentAge }} a√±os = </span>
            <span class="formula-result">{{ rule120RecommendedRisk }}% en riesgo</span>
          </div>

          <div class="allocation-comparison">
            <div class="alloc-section">
              <div class="alloc-label">Recomendado para ti</div>
              <div class="alloc-bars">
                <div class="alloc-bar-container">
                  <div class="alloc-bar risky" [style.width.%]="rule120RecommendedRisk"></div>
                  <div class="alloc-bar conservative" [style.width.%]="rule120RecommendedConservative"></div>
                </div>
                <div class="alloc-legend">
                  <span class="legend-risky">{{ rule120RecommendedRisk }}% Riesgo</span>
                  <span class="legend-conservative">{{ rule120RecommendedConservative }}% Conservador</span>
                </div>
              </div>
            </div>

            @if (investmentSvc.investments().length > 0) {
              <div class="alloc-section">
                <div class="alloc-label">Tu portafolio actual</div>
                <div class="alloc-bars">
                  <div class="alloc-bar-container">
                    <div class="alloc-bar risky" [style.width.%]="currentRiskyPercentage"></div>
                    <div class="alloc-bar conservative" [style.width.%]="currentConservativePercentage"></div>
                  </div>
                  <div class="alloc-legend">
                    <span class="legend-risky">{{ currentRiskyPercentage | number:'1.0-0' }}% Riesgo</span>
                    <span class="legend-conservative">{{ currentConservativePercentage | number:'1.0-0' }}% Conservador</span>
                  </div>
                </div>
              </div>

              <div class="rule120-status" [class]="riskAllocationStatus">
                {{ getRiskStatusMessage() }}
              </div>
            } @else {
              <div class="alloc-empty">
                <p>Agrega inversiones para ver c√≥mo se compara tu portafolio con la recomendaci√≥n</p>
              </div>
            }
          </div>

          <div class="rule120-types">
            <div class="type-group">
              <span class="type-label risky">üî• Mayor riesgo/rendimiento:</span>
              <span class="type-list">Acciones, ETFs, Cripto</span>
            </div>
            <div class="type-group">
              <span class="type-label conservative">üõ°Ô∏è Menor riesgo/rendimiento:</span>
              <span class="type-list">Bonos, Bienes Ra√≠ces, Fondos Mutuos</span>
            </div>
          </div>
        </div>

        @if (investmentSvc.investments().length > 0) {
          <div class="card"><h3 class="card-title">Distribuci√≥n por Tipo</h3>
            <div class="distribution-list">
              @for (item of getInvestmentsByType(); track item.type.value) {
                <div class="dist-row">
                  <div class="dist-info"><span>{{ item.type.label }}</span><span class="dist-amount">{{ item.total | currencyMxn }} ({{ item.percentage | number:'1.1-1' }}%)</span></div>
                  <div class="dist-bar"><div class="dist-fill" [style.width.%]="item.percentage" [style.background]="item.type.color"></div></div>
                </div>
              }
            </div>
          </div>

          <div class="card compound-card"><h3 class="card-title"><ion-icon name="trending-up-outline"></ion-icon> Proyecci√≥n a Futuro</h3>
            <div class="projection-grid">
              <div class="projection-item"><span class="proj-label">1 a√±o</span><span class="proj-value">{{ getInvestmentProjection(1) | currencyMxn }}</span></div>
              <div class="projection-item"><span class="proj-label">5 a√±os</span><span class="proj-value">{{ getInvestmentProjection(5) | currencyMxn }}</span></div>
              <div class="projection-item"><span class="proj-label">10 a√±os</span><span class="proj-value">{{ getInvestmentProjection(10) | currencyMxn }}</span></div>
            </div>
            <p class="proj-note">* Proyecciones basadas en tu retorno promedio de {{ weightedReturn | number:'1.1-1' }}%</p>
          </div>
        }
      </main>
    }
  </div>

</ion-content>

@if (showCalculatorModal) {
  <app-salary-calculator-modal [initialNetSalary]="calculatorInitialValue" (salarySelected)="onSalaryCalculated($event)" (cancelled)="closeCalculatorModal()"></app-salary-calculator-modal>
}

@if (showGoalModal) {
  <app-savings-goal-modal [editGoal]="editingGoal" (goalCreated)="onGoalCreated($event)" (goalUpdated)="onGoalUpdated($event)" (cancelled)="closeGoalModal()"></app-savings-goal-modal>
}
